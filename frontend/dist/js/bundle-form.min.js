var m=window.location.hostname==="localhost"?"http://localhost:3000":"https://librairie-simple-production-6ca3.up.railway.app",n=m;async function u(){let e=localStorage.getItem("userId");if(!e)return!1;try{let t=await fetch(`/api/auth/${e}`);if(!t.ok)throw new Error("Erreur lors de la v\xE9rification de l'authentification");let r=await t.json();return console.log("Donn\xE9es d'authentification re\xE7ues :",r),{isAuth:r.isAuth,user:r.result}}catch(t){return console.error("Erreur lors de la v\xE9rification de l'authentification :",t),!1}}var i=await u(),p=document.querySelector(".auth-field"),f=document.querySelector(".user-menu"),d=document.querySelector(".main-container span"),c=!!(i&&i.user),h=i&&i.user?i.user.username:void 0;p.style.display=c?"none":"flex";f.style.display=c?"inline-block":"none";d&&c&&(d.textContent=h?`Ta gueule ${h} !`:"Donc faudrait la fermer un moment..");document.getElementById("user-menu-button").addEventListener("click",()=>{let e=document.getElementById("user-menu-options");if(!e)return;e.style.display=e.style.display==="block"?"none":"block";let t=r=>{!e.contains(r.target)&&r.target.id!=="user-menu-button"&&(e.style.display="none",document.removeEventListener("click",t))};e.style.display==="block"&&(document.addEventListener("click",t),document.getElementById("logout-button").addEventListener("click",async()=>{if(confirm("\xCAtes-vous s\xFBr de vouloir vous d\xE9connecter ?")){let a=localStorage.getItem("userId");if(!a){alert("Impossible de trouver l'ID utilisateur pour la d\xE9connexion.");return}let s=await fetch(`${n}/api/auth/logout/${a}`,{method:"POST",credentials:"include"});if(!s.ok){alert("Erreur lors de la d\xE9connexion.");return}let l=await s.json();alert(l.message),console.log(l.message),localStorage.removeItem("userId"),localStorage.removeItem("username"),localStorage.removeItem("role"),window.location.href="/"}}))});var y=document.querySelectorAll(".add");y.forEach(e=>{e.addEventListener("submit",async t=>{t.preventDefault();let r=new FormData(e),o=Object.fromEntries(r.entries());if(e.classList.contains("add-author")){if(await v(o.fullName,o.birthYear)){alert(`Un auteur "${o.fullName}" (${o.birthYear}) existe d\xE9j\xE0 dans la base de donn\xE9es.`);return}await w(o)&&(alert("\u2705 Auteur cr\xE9\xE9 avec succ\xE8s !"),e.reset())}else if(e.classList.contains("add-book")){if(await b(o.title,o.authorId)){alert(`Le livre "${o.title}" existe d\xE9j\xE0 pour cet auteur dans la base de donn\xE9es.`);return}await E(o)&&(alert("\u2705 Livre cr\xE9\xE9 avec succ\xE8s !"),e.reset())}else if(e.classList.contains("add-loan")){if((await k(o.bookId)).length===0){alert("Le livre n'est pas disponible pour l'emprunt. Veuillez choisir un autre livre.");return}await g(o)&&(alert("\u2705 Emprunt cr\xE9\xE9 avec succ\xE8s !"),e.reset())}else console.log("Formulaire non reconnu");console.log("Form data submitted:",o)})});async function w(e){try{let t={full_name:e.fullName,birth_year:e.birthYear,nationality:e.nationality},r=await fetch(`${n}/api/authors`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error("Erreur API");return await r.json()}catch(t){console.error("Erreur serveur",t),alert("Auteur : Erreur")}}async function E(e){try{let t={title:e.title,authorId:e.authorId,year:e.publicationYear},r=await fetch(`${n}/api/books`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok){let a=await r.json();throw new Error(a.message||"Erreur API")}return await r.json()}catch(t){console.error("Erreur serveur",t),alert("Livre : Erreur")}}async function g(e){try{let t={book_id:e.bookId,borrower_name:e.borrowerName,borrowed_date:e.fromDate,return_date:e.toDate||null},r=await fetch(`${n}/api/loans`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok){let a=await r.json();throw new Error(a.message||"Erreur API")}return await r.json()}catch(t){console.error("Erreur serveur",t),alert("Emprunt : "+t.message)}}async function v(e,t){try{let r=await fetch(`${n}/api/authors`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error("Erreur API");return(await r.json()).some(a=>a.full_name.toLowerCase()===e.toLowerCase()&&a.birth_year==t)}catch(r){return console.error("Erreur serveur",r),!1}}async function b(e,t){try{let r=await fetch(`${n}/api/books`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error("Erreur API");return(await r.json()).some(a=>a.title.toLowerCase()===e.toLowerCase()&&a.author_id==t)}catch(r){return console.error("Erreur serveur",r),!1}}async function k(e){try{let t=await fetch(`${n}/api/books/available/${e}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Erreur API");return await t.json()}catch(t){console.error("Erreur serveur",t),alert("R\xE9cup\xE9ration des livres disponibles : Erreur")}}
