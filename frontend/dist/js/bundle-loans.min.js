(()=>{var E=window.location.hostname==="localhost"?"http://localhost:3000":"https://librairie-simple-production-6ca3.up.railway.app",i=E;var h=class{constructor(t,e){this.currentPage=1,this.totalPages=1,this.fetchFunction=t,this.renderFunction=e,this.leftBtn=document.getElementById("gauche"),this.rightBtn=document.getElementById("droite"),this.init()}init(){this.leftBtn.addEventListener("click",()=>this.goToPreviousPage()),this.rightBtn.addEventListener("click",()=>this.goToNextPage()),this.loadPage(this.currentPage)}async loadPage(t){try{let e=await this.fetchFunction(t),r,o;Array.isArray(e)?(console.warn("\u26A0\uFE0F API retourne l'ancien format (array). Mise \xE0 jour backend recommand\xE9e."),r=e,o={page:this.currentPage,totalPages:1,total:e.length,limit:e.length}):(r=e.data,o=e.pagination),this.currentPage=o.page,this.totalPages=o.totalPages,this.renderFunction(r),this.updateButtons()}catch(e){console.error("Erreur lors du chargement de la page :",e)}}goToPreviousPage(){this.currentPage>1&&this.loadPage(this.currentPage-1)}goToNextPage(){this.currentPage<this.totalPages&&this.loadPage(this.currentPage+1)}updateButtons(){this.leftBtn.disabled=this.currentPage===1,this.rightBtn.disabled=this.currentPage===this.totalPages}resetToFirstPage(){this.currentPage=1,this.loadPage(1),this.loadPage(1)}},d=h;var u=document.getElementById("loans"),P=document.getElementById("apply-filters"),y=document.querySelector("input[type='search']"),v=document.querySelector(".search-bar button"),m=document.querySelector(".reset-search");v.addEventListener("click",()=>w());async function w(){try{m&&(m.style.display="flex");let n=y.value.trim();y.value="";let t=await l(1,n);c(t.data)}catch(n){console.error("Erreur lors de la recherche :",n),alert("Erreur lors de la recherche des emprunts")}}m.addEventListener("click",async()=>{try{m.style.display="none";let n=await l(1);c(n.data),a&&a.resetToFirstPage()}catch(n){console.error("Erreur lors de la r\xE9initialisation :",n),alert("Erreur lors de la r\xE9initialisation de la recherche")}});var s={};async function l(n=1,t=""){let e=new URLSearchParams({page:n,limit:6,...t&&{filtered:t}}),r=await fetch(`${i}/api/loans?${e.toString()}`);if(!r.ok)throw new Error("Erreur avec l'API");return await r.json()}var a=new d(l,c);function c(n){if(u.innerHTML="",n.length===0){u.innerHTML="<p class='error'>Aucun emprunt trouv\xE9.</p>";return}n.forEach(t=>{let e=document.createElement("div");e.classList.add("loan-card"),e.setAttribute("data-loan-id",t.id);let r=`
			<div class="loan-header">
				<h3>Livre ID: ${t.book_id}</h3>
			</div>
			<span class="delete-loan-button">X</span>
			<div class="loan-info">
				<p><strong>Emprunteur:</strong> ${t.borrower_name}</p>
				<p><strong>Date d'emprunt:</strong> ${t.borrowed_date}</p>
				<p><strong>Date de retour:</strong> ${t.return_date?t.return_date:"Non retourn\xE9"}</p>
				<p><strong>Statut:</strong> ${t.loan_status==="active"?"En cours":"Retourn\xE9"}</p>
			</div>
		`;e.innerHTML=r,u.appendChild(e)})}P.addEventListener("click",async n=>{n.preventDefault();let t=document.getElementById("book-name-input").value.trim(),e=document.getElementsByClassName("borrower-name").value.trim(),r=document.querySelector('input[name="status"]:checked')?.value||"",o=document.getElementById("date-from").value,f=document.getElementById("date-to").value;s={},e&&(s.borrower_name=e),t&&(s.book_name=t),r&&(s.status=r),o&&(s.date_from=o),f&&(s.date_to=f),console.log("Filtres appliqu\xE9s:",s),a&&a.destroy();let B=new d(l,c)});var g=document.getElementById("edit-loan-modal"),I=document.getElementById("close-modal"),p=document.getElementById("edit-loan-form");I.addEventListener("click",()=>{g.close()});u.addEventListener("click",async n=>{let t=n.target.closest(".loan-card");if(!t)return;let e=t.dataset.loanId;if(n.target.classList.contains("delete-loan-button")){if(!confirm("Voulez-vous vraiment supprimer cet emprunt ?"))return;try{if(!(await fetch(`${i}/api/loans/${e}`,{method:"DELETE"})).ok)throw new Error("Erreur lors de la suppression");console.log("Emprunt supprim\xE9, ID:",e),a&&a.refresh()}catch(r){console.error("Erreur:",r),alert("Impossible de supprimer l'emprunt")}return}try{let r=await fetch(`${i}/api/loans/${e}`);if(!r.ok)throw new Error("Erreur lors de la r\xE9cup\xE9ration de l'emprunt");let o=await r.json();document.getElementById("edit-loan-status").value=o.loan_status||"active",document.getElementById("borrower-name").value=o.borrower_name||"",document.getElementById("return-date").value=o.return_date||"",p.dataset.loanId=e,g.showModal()}catch(r){console.error("Erreur:",r),alert("Impossible de charger les donn\xE9es de l'emprunt")}});p.addEventListener("submit",async n=>{n.preventDefault();let t=p.dataset.loanId,e={status:document.getElementById("edit-loan-status").value,borrower_name:document.getElementById("borrower-name").value,return_date:document.getElementById("return-date").value||null};try{let r=await fetch(`${i}/api/loans/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok)throw new Error("Erreur lors de la mise \xE0 jour");let o=await r.json();console.log("Emprunt mis \xE0 jour:",o),g.close(),a&&a.refresh()}catch(r){console.error("Erreur:",r),alert("Impossible de mettre \xE0 jour l'emprunt")}});a=new d(l,c);})();
