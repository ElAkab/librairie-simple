var B=window.location.hostname==="localhost"?"http://localhost:3000":"https://librairie-simple-production-6ca3.up.railway.app",i=B;var f=class{constructor(t,e){this.currentPage=1,this.totalPages=1,this.fetchFunction=t,this.renderFunction=e,this.leftBtn=document.getElementById("gauche"),this.rightBtn=document.getElementById("droite"),this.init()}init(){this.leftBtn.addEventListener("click",()=>this.goToPreviousPage()),this.rightBtn.addEventListener("click",()=>this.goToNextPage()),this.loadPage(this.currentPage)}async loadPage(t){try{let e=await this.fetchFunction(t),o,n;Array.isArray(e)?(console.warn("\u26A0\uFE0F API retourne l'ancien format (array). Mise \xE0 jour backend recommand\xE9e."),o=e,n={page:this.currentPage,totalPages:1,total:e.length,limit:e.length}):(o=e.data,n=e.pagination),this.currentPage=n.page,this.totalPages=n.totalPages,this.renderFunction(o),this.updateButtons()}catch(e){console.error("Erreur lors du chargement de la page :",e)}}goToPreviousPage(){this.currentPage>1&&this.loadPage(this.currentPage-1)}goToNextPage(){this.currentPage<this.totalPages&&this.loadPage(this.currentPage+1)}updateButtons(){this.leftBtn.disabled=this.currentPage===1,this.rightBtn.disabled=this.currentPage===this.totalPages}resetToFirstPage(){this.currentPage=1,this.loadPage(1),this.loadPage(1)}},m=f;async function I(){let r=localStorage.getItem("userId");if(!r)return!1;try{let t=await fetch(`/api/auth/${r}`);if(!t.ok)throw new Error("Erreur lors de la v\xE9rification de l'authentification");let e=await t.json();return console.log("Donn\xE9es d'authentification re\xE7ues :",e),{isAuth:e.isAuth,user:e.result}}catch(t){return console.error("Erreur lors de la v\xE9rification de l'authentification :",t),!1}}var c=await I(),L=document.querySelector(".auth-field"),k=document.querySelector(".user-menu"),w=document.querySelector(".main-container span"),E=!!(c&&c.user),P=c&&c.user?c.user.username:void 0;L.style.display=E?"none":"flex";k.style.display=E?"inline-block":"none";w&&E&&(w.textContent=P?`Ta gueule ${P} !`:"Donc faudrait la fermer un moment..");document.getElementById("user-menu-button").addEventListener("click",()=>{let r=document.getElementById("user-menu-options");if(!r)return;r.style.display=r.style.display==="block"?"none":"block";let t=e=>{!r.contains(e.target)&&e.target.id!=="user-menu-button"&&(r.style.display="none",document.removeEventListener("click",t))};r.style.display==="block"&&(document.addEventListener("click",t),document.getElementById("logout-button").addEventListener("click",async()=>{if(confirm("\xCAtes-vous s\xFBr de vouloir vous d\xE9connecter ? (Tout progr\xE8s sera perdu)")){let n=localStorage.getItem("userId");if(!n){alert("Impossible de trouver l'ID utilisateur pour la d\xE9connexion.");return}let l=await fetch(`${i}/api/auth/logout/${n}`,{method:"POST",credentials:"include"});if(!l.ok){alert("Erreur lors de la d\xE9connexion.");return}let p=await l.json();alert(p.message),console.log(p.message),localStorage.removeItem("userId"),localStorage.removeItem("username"),localStorage.removeItem("role"),window.location.href="/"}}))});var h=document.getElementById("loans"),S=document.getElementById("apply-filters"),b=document.querySelector("input[type='search']"),_=document.querySelector(".search-bar button"),g=document.querySelector(".reset-search");_.addEventListener("click",()=>$());async function $(){try{g&&(g.style.display="flex");let r=b.value.trim();b.value="";let t=await u(1,r);d(t.data)}catch(r){console.error("Erreur lors de la recherche :",r),alert("Erreur lors de la recherche des emprunts")}}g.addEventListener("click",async()=>{try{g.style.display="none";let r=await u(1);d(r.data),a&&a.resetToFirstPage()}catch(r){console.error("Erreur lors de la r\xE9initialisation :",r),alert("Erreur lors de la r\xE9initialisation de la recherche")}});var s={};async function u(r=1,t=""){let e=new URLSearchParams({page:r,limit:6,...t&&{filtered:t}}),o=await fetch(`${i}/api/loans?${e.toString()}`);if(!o.ok)throw new Error("Erreur avec l'API");return await o.json()}var a=new m(u,d);function d(r){if(h.innerHTML="",r.length===0){h.innerHTML="<p class='error'>Aucun emprunt trouv\xE9.</p>";return}r.forEach(t=>{let e=document.createElement("div");e.classList.add("loan-card"),e.setAttribute("data-loan-id",t.id);let o=`
			<div class="loan-header">
				<h3>Livre ID: ${t.book_id}</h3>
			</div>
			<span class="delete-loan-button">X</span>
			<div class="loan-info">
				<p><strong>Emprunteur:</strong> ${t.borrower_name}</p>
				<p><strong>Date d'emprunt:</strong> ${t.borrowed_date}</p>
				<p><strong>Date de retour:</strong> ${t.return_date?t.return_date:"Non retourn\xE9"}</p>
				<p><strong>Statut:</strong> ${t.loan_status==="active"?"En cours":"Retourn\xE9"}</p>
			</div>
		`;e.innerHTML=o,h.appendChild(e)})}S.addEventListener("click",async r=>{r.preventDefault();let t=document.getElementById("book-name-input").value.trim(),e=document.getElementsByClassName("borrower-name").value.trim(),o=document.querySelector('input[name="status"]:checked')?.value||"",n=document.getElementById("date-from").value,l=document.getElementById("date-to").value;s={},e&&(s.borrower_name=e),t&&(s.book_name=t),o&&(s.status=o),n&&(s.date_from=n),l&&(s.date_to=l),console.log("Filtres appliqu\xE9s:",s),a&&a.destroy();let p=new m(u,d)});var v=document.getElementById("edit-loan-modal"),T=document.getElementById("close-modal"),y=document.getElementById("edit-loan-form");T.addEventListener("click",()=>{v.close()});h.addEventListener("click",async r=>{let t=r.target.closest(".loan-card");if(!t)return;let e=t.dataset.loanId;if(r.target.classList.contains("delete-loan-button")){if(!confirm("Voulez-vous vraiment supprimer cet emprunt ?"))return;try{if(!(await fetch(`${i}/api/loans/${e}`,{method:"DELETE"})).ok)throw new Error("Erreur lors de la suppression");console.log("Emprunt supprim\xE9, ID:",e),a&&a.refresh()}catch(o){console.error("Erreur:",o),alert("Impossible de supprimer l'emprunt")}return}try{let o=await fetch(`${i}/api/loans/${e}`);if(!o.ok)throw new Error("Erreur lors de la r\xE9cup\xE9ration de l'emprunt");let n=await o.json();document.getElementById("edit-loan-status").value=n.loan_status||"active",document.getElementById("borrower-name").value=n.borrower_name||"",document.getElementById("return-date").value=n.return_date||"",y.dataset.loanId=e,v.showModal()}catch(o){console.error("Erreur:",o),alert("Impossible de charger les donn\xE9es de l'emprunt")}});y.addEventListener("submit",async r=>{r.preventDefault();let t=y.dataset.loanId,e={status:document.getElementById("edit-loan-status").value,borrower_name:document.getElementById("borrower-name").value,return_date:document.getElementById("return-date").value||null};try{let o=await fetch(`${i}/api/loans/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok)throw new Error("Erreur lors de la mise \xE0 jour");let n=await o.json();console.log("Emprunt mis \xE0 jour:",n),v.close(),a&&a.refresh()}catch(o){console.error("Erreur:",o),alert("Impossible de mettre \xE0 jour l'emprunt")}});a=new m(u,d);
